# 設計ノート
このノートは当該機器の電子回路設計の履歴や設計意図を記録しています。</br>
回路動作の理解や改善・修理などにご利用ください

## ノート修正履歴
- 初版：2024/11/30  宮本

## 設計の概要
### マーカコイルドライバ本体
マーカコイルドライバはMEGのセンサ近くで動作させるため、本体から輻射する電磁ノイズ、シールドルーム外から誘導されて侵入してくる電磁ノイズを厳しくコントロールする必要があります。</br>
これを実現するためマーカコイルドライバ本体は電源として充電池を採用し、さらに外部機器（MEGデータ収録装置）との接続を光ファイバを用いて電気的に絶縁することで必要十分な低ノイズを実現しています。

#### 設計のポイント
1. 電磁ノイズの低減<br></br>
    電源に充電池を使用しました。外部（交流電源）から生成した電源を使用しないことで、ノイズの流入を防ぎます。</br>
    その代償として、回路の動作電圧が5V程度に制限されてしまいます。これをプッシュプル回路で等価的に2倍のドライブ電圧にすることで補っています。また、ドライブする電流がマイクロアンペア程度と比較的小さいことも低電圧で十分なドライブができる要因です。</br>
    外部との接続にはプラスティックファイバ用のトランシーバを利用しています。このトランシーバは通常10Mbps程度の高速データ通信を行うために設計されており、高電流（数十ｍA）で送信側をドライブするよう最適化されていますが、このマーカコイルドライバの設計ではOn/Offの情報を伝えるだけの単純な情報伝達であり高速で駆動する必要がなく、逆に高速駆動のための稼働条件では駆動電流により発生する磁気ノイズが大きくなると言う問題が発覚しました。この駆動電流起因の磁気ノイズを低減するという目的で、トランシーバの仕様書上のドライブ条件よりも低い駆動電流になるよう設計しています。<br></br>

2. プッシュプル回路によるコイルのドライブ<br></br>
    電源電圧が5V以下と低い（実際には3.3Vでの動作）となっていますが、安定したコイル駆動のためにはできるだけ高いドライブ電圧を稼ぐ必要があります。低電圧電源の欠点を回避するため、コイルの両端を逆位相の電圧で駆動する「プッシュプル」構成のドライブ回路としました。これにより等価的にシングルエンド駆動の2倍の電圧でコイルを駆動することができます。</br>
    また、回路のGND電位をコイルに導入しない構成のため、MEGのセンサの近傍に来るのは比較的高インピーダンスの信号線（コイルドライブ電流の供給用電線）となり、ドライブ回路のコモンモード電圧に高周波ノイズが発生したとしても、センサ側に影響を与えにくいと考えています。</br>
    （そもそも電池で駆動しているドライブ回路のコZモンモード電圧は発生しないと考えられますが、ドライバの筐体が他の機器のGNDに接触してしまうなど、利用状況によって発生する可能性も無視できません）<br></br>

3. リモコンとの接続回路をコイル駆動回路から分離<br></br>
    リモコンからの動作モード変更指示を受付けて処理する回路とマーカコイルドライバの同期信号をリモコンに送る回路の電源を、マーカコイルドライバのアナログ回路の電源を可能な限り分離しました。また、信号自身もフォトカプラにより絶縁されており、GNDラインの共通インピーダンスによるリモコンインターフェイス回路側の信号のアナログ回路への漏れ込みを最小限に抑えています。<br></br>

4. 注意<br></br>
    回路図中、ロジック信号の負論理は！を信号名の前につけて表記しています（いにしえの表記です）。最近は#とか/とかかと思いますが、設計（者）が古いのでご勘弁。
   
#### 回路の動作
1. リモコンインターフェイス回路(回路図　sheet 1/5)<br></br>
    リモコンインターフェイス回路は次の2つの仕事をしています。</br>
    - __動作モードの設定：__ </br>
        リモコンから50msより長いパルス幅のパルスが来た場合、動作モードを状態遷移図に従って変更します。パルス幅変調による1bit情報です。

        - 1（パルス幅が50msより長い）：モードの更新　動作モードが変更されます。
        - 0（パルス幅が50msより短い）：リセット　スタンバイ状態に戻ります。
  
        リモコンからのモード変更指示の信号は光ファイバのトランシーバU6を通して、RCフィルタによるLPF(R26//C5)により高い周波数のパルス（ノイズ）が除去されたのちレベルコンパレータに入力されています。これにより、誤動作を防いでいます。</br>
        その後、パルス幅の判別が行われ(U11A)、判別結果に従って動作モードを決定する簡単なステートマシン(U9,U12)が駆動されます</br>
        ステートマシンの状態はPOWER_80とPOWER_RETHMの2つの信号によってドライブ回路側に渡されています。（ともにフォトカプラU7,U8を経由しています）

        ##### ステートマシンの図示
        ![Test Image 1](/figures/StateMachine.png)


    <br></br>
    - __同期信号の送出：__ </br>
        外部機器で信号処理のため必要となるマーカコイルドライバ回路の同期信号は、フォトカプラ(U1)を経由してリモコンインターフェイス回路に導入されます。この信号はU4のバッファにより電流増幅され、光ファイバのトランスミッタ(U3)をドライブします。U4のバッファICのドライブ能力は1つのゲートあたり6mAで、それを7本並列に使用しているので理論上は40mA以上のドライブができる計算です（実際の電流上限はU4の絶対最大定格によって制限されます）。この回路ではトランスミッタのドライブ電流は8mA程度となっています。</br>
        リモコンと本体の間に長いファイバを使う必要があるなどの場合、R5を調整してトランスミッタからの光強度をあげることも可能です。その場合、U4の絶対最大定格を考慮して電流設定を行なってください。 実績としては、10m程度のファイバであれば回路図の設定で十分安定して動作します。</br>
        U4のバッファICは80Hzモード、ReTHMモードの場合にイネーブルになります(U4-G1/G2)。<br></br>
    

1. コイルドライブ回路（80Hzモード） (回路図 Sheet 2/5)<br></br>
    コイルドライブ回路は次の回路で構成されています。</br>
    - __80Hz発振回路：__ </br>
        U15の2個のオペアンプで構成されるのが、80Hzモードでのドライブ信号を発生するための発振器です。</br>
        R51で発振周波数を調整、R40で振幅を調整します。発振周波数と振幅を設計値に収束させるためには2〜3回程度の交互調整が必要です。
        <br></br>

    - __プッシュプル/電流設定回路：__ </br>
        プッシュプルドライブ回路は、U13のオペアンプで構成される非反転アンプ、反転アンプのペアです。この設計ではドライブ電流のノイズを抑えるため、1kHz以上の帯域と3Hz以下のDC領域をカットするためのCRフィルタをプッシュプル回路の入力に設置しています。</br>
        非反転アンプと反転アンプの位相が常に180°あることで回路が成立しますが、実際には位相不整合が起こります。それについては以下のように考えます。</br>
        同じオペアンプを使っても非反転・反転の回路構成から帰還量が2倍違うので帯域に差が出てきます。帯域差があるということは位相差も発生するということです。しかし、この設計ではオペアンプのGBW(1MHz)に比較して信号周波数(80Hz)が十分低いのでアンプの帯域に起因する問題（両出力間での信号位相の不整合）は非常に小さいと判断しています。位相の不整合は駆動電流の誤差、信号の歪みとして現れますが、仕様上の駆動電流の誤差は位相不整合での誤差に対してかなり余裕があると考えられます。</br>
        電流設定は、信号の振幅切り替えと出力インピーダンス切り替えの2つのステージで行われます。</br>
        発振回路からの80Hzの信号はR43/R24で1/2に分圧され、その後U14で構成される、x1/x2利得切替の非反転アンプにて振幅切替が行われます。この振幅切り替えが電流調整の1段階目です。</br>
        その後、プッシュプルドライブ回路に入り、その出力インピーダンスを2段で切り替える回路(U16)が電流設定回路の2段階目となります。</br>
        通常、定電流制御の回路を導入しますが、負荷が管理されたコイルを駆動しておりインピーダンスのばらつきが少ないこと、出力電流がμAオーダーと小さいことから抵抗による電圧ー電流変換回路としました。</br>
        定電流制御の回路を入れる場合は、電流検出抵抗の電圧を差動アンプで計測し、プッシュプル回路の前に電圧制御としてフィードバックするような回路がいいのではないかと思います。ただし、電流の変化幅が20倍程度ありますので、振幅だけで制御するとノイズが目立ったりする可能性もあります。出力インピーダンスの切り替えと振幅制御の2つで20倍をカバーするのがいいように思います。
        <br></br>
    
    - __マルチプレクサ：__ </br>
        5チャネルのマーカコイルを順次駆動するためにマルチプレクサU22を使います。スイッチの切り替えはCPLDによるシーケンス回路で制御されます。スイッチは低リークのものを選んでいます。そのためon抵抗は比較的高くなりますが、信号の出力インピーダンスが高いため大きな誤差にはならないと考えています。必要であればR37,44,55,57の値を調整して対応が可能です。</br>
        マルチプレクサICでのリーク電流は定電流なので電流の誤差としては直流として現れます。頭部位置計測ではマーカコイルの信号の振幅が重要な要素ではありますが、直流成分の情報は必要とされていませんので問題ないと判断しました。また、リーク電流とコイル駆動電流を比較してみると、使用したデバイスのリーク電流は1nA程度でコイルドライブの出力電流に対しては1/1000以下となっています。</br>
        マルチプレクサの出力はマーカコイルを接続するコネクタ（ステレオタイプ・ミニジャック）に行きますが、その前にコモンモードコイルを通しています。コモンモードの高周波の電圧がコイルにかかり、MEGのセンサ側の信号線に対して電磁波として流入するのを防ぐために挿入していますが、効果の有無は明らかではありません。なくてもいいかもしれません。
        <br></br>

    - __中間電位設定回路：__ </br>
        発振回路とプッシュプルドライブ回路を動作させるためには、動作の中心となる中間電位が必要となります。その電位を発生するための回路がU14Bを用いて構成されています。</br>
        アナログ回路全体の電圧が3.3Vですので、その中間の電圧、1.65VをR68,R71で生成しU14Bでバッファリングし、C28により安定化／高域での低インピーダンス化をしています。
        <br></br>

    - __電源電圧監視回路：__ </br> 
        バッテリ電圧の状態を監視するために電圧監視IC（U19）を導入しています。</br>
        バッテリの電圧が4.79Vより低くなった場合、LOW_BAT信号をアクティブにして本体パネルのLED表示とCPLDへの通知を行います。この設計では、LOW_BATのアサートにより動作が停止が停止するということはありません。 </br>
        バッテリ残量のスレッショルド4.79Vは、充電池（eneloopを想定）4本合計の定格電圧から設定しています。高負荷の場合、電池の内部抵抗により1本あたり1.2Vの電位は発生できませんが、この回路は低消費電力で電池の負荷電流は500uA程度ですので、満充電の状態の電池1本あたり1.2Vを超えて電圧を発生することを確認しています。</br>
        この電圧設定にて、満充電の電池を使用したLOW_BAT信号がアクティブになるまでの連続動作テストを行い、60時間程度の連続動作を確認しています。
        <br></br>

    - __クロック作成回路：__ </br>
        80Hzの発振回路からの正弦波をコンパレータ(U17)で矩形波に変換し、パルスシーケンスをコントロールするCPLDのためのクロック信号を作成しています。コンパレートレベルは電源電圧の中間電位近辺です。</br>
        コンパレータは若干のスレッショルドを設定しており、80Hzの信号のノイズに対するクロックの安定性を考慮しています。また、CPLDからのCOMP_80信号によりコンパレータの動作on/offが可能です。（この設計では使用していません）<br></br>

2. ReTHM発振器接続回路 (回路図 Sheet 3/5)<br></br>
    ReTHM計測では周波数の異なる５個の発振器を同時に動作させ、接続されている５個コイルを個別に駆動します。そのためのReTHM用発振器の制御の配線が記載されています。</br>
    - __制御：__ </br>
        ５個の発振器は共通の制御線RETHM_POWERによって電源のOn/Offが行われます。この信号はReTHM発振器内部のレギュレータのEN端子に接続されており、Offの場合ReTHM発振回路は電力を消費しません。<br>
        ZOUT,AMP_0,AMP_1はReTHM発振器内部の電流駆動回路の設定をするための信号で、80Hzでの駆動回路と同じように、振幅と出力抵抗で電流量を設定しています。
        <br></br>

    - __コイル駆動出力端子(OUT+/OUT-)：__ </br>
        ReTHM発振器は80Hz駆動用MUXの出力と接続されていますが、RETHM_POWER=0あるいは!RETHM_OE=1の場合、出力がハイインピーダンスとなることで、80Hzでの駆動と排他的にコイルに接続されます。逆に!ReTHM_OE=0の場合、CPLD内部の処理により80Hz信号のMUX(U21)のENがネゲートされ80Hz出力がハイインピーダンスとなります。
        <br></br>

    - __同期信号(SYNC)：__ </br>
        出力信号に同期した矩形波を出力しています。CPLDに接続されていますが、この設計では利用していません。
        <br></br>


4. Sequencer ~ CPLD周辺回路 (回路図 Sheet 4/5)<br></br>
    80Hzモードでのコイルの切り替えタイミングや、電流設定、同期信号の出力、ReTHMモード・80Hzモードの切り替えなどを行うCPLD周りの回路です。CPLDに書き込まれているロジック回路については別途解説があります。</br>
    - __スイッチ入力：__ </br>
        回路図では4つのスイッチが記載されていますが、実際に使っているのはSW2A,SW3Aの2つです。これらは電流設定のためのスイッチで、CPLDで解釈され、CPLDの端子 AMP_0, AMP_1, ZOUT　の状態が決定します。この状態はReTHM発振回路、80Hz発振回路に共通です。
        <br></br>

    - __動作クロック：__ </br>
        CPLD内部の動作のためのクロックは80Hz発振回路からの同期信号(SYNC_80)を用いています。
        <br></br>

    - __制御信号：__ </br>
        全体の動作を決める信号は、POWER_ON, RMT_80/RETHM の2つになります。POWER_ONは全体の動作を開始するための信号で、RMT_80/RETHMは80HzモードとReTHMモードの切り替えの信号です。これらの信号はリモコンインターフェイス回路のステートマシンで作られます。</br>
        <br></br>

    - __80Hz発振器設定：__ </br>
        80Hzモードの動作を設定するのは次の4つの信号です。
        80_OE, AMP_0, AMP_1, ZOUT
        80Hzでの駆動をOn/Offする(80_OE)、駆動電流の制御(AMP_0, AMP_1, ZOUT)となります。
        <br></br>
    
    - __ReTHM発振器設定：__ </br>
        ReTHMモードの動作を設定するのは次の5つの信号です。
        RETHM_POWER, !RETHM_OE, AMP_0, AMP_1, ZOUT
        ReTHM発振器の電源(RETHM_POWER)、ReTHM発振器での駆動をOn/Offする(!RETHM_OE)、駆動電流の制御(AMP_0, AMP_1, ZOUT)となります。</br>
        駆動電流の制御信号は80Hz発振器の設定と共通の信号です。
        <br></br>

    - __同期信号：__ </br>
        80Hzモードの場合、５個のコイルを順次励磁して1つのシーケンスとなります。同期信号はこのシーケンスごとに出力されます。(FRAME_SYNC)

        <br></br>

    - 信号名のある端子の利用状況
  
        | 名前 | I/O |解説 | 利用状況 |
        --|--|--|--
        | RETHM_F4 |I| ReTHM発振器同期信号（入力） | 未使用|
        | RETHM_F3 |I| ReTHM発振器同期信号（入力）| 未使用|
        | RETHM_F2 |I| ReTHM発振器同期信号（入力） | 未使用|
        | RETHM_F1 |I| ReTHM発振器同期信号（入力） | 未使用|
        | RETHM_F0 |I| ReTHM発振器同期信号（入力） | 未使用|
        | !RETHM_OE |O|ReTHM発振器出力イネーブル | 利用|
        | !LOW_BAT |I|バッテリ電圧低下 | 未使用|
        | CH_2 |O| 80Hz MUXチャンネル設定 |利用|
        | CH_1 |O| 80Hz MUXチャンネル設定 |利用|
        | CH_0 |O| 80Hz MUXチャンネル設定 |利用|
        | 80_OE |O| 80Hz MUX出力イネーブル |利用|
        | SYNC_80 |I| 80Hz 同期信号（CPLD内部動作クロック） |利用|
        | AMP_0|O| 電流設定（電圧制御設定） |利用|
        | AMP_1 |O| 電流設定（電圧制御設定） |利用|
        | ZOUT |O| 電流設定（出力インピーダンス設定） |利用|
        | COMP_80 |O| 80Hz同期信号作成用コンパレータOn/Off |利用(Hi固定)|
        | RETHM_POWER |O| RETHM発振器電源制御 |利用|
        | SW_80Hz/!RETHM |I| 80Hz/ReTHM切り替え |未使用|
        | SW_OPTION |I| 予備のスイッチ入力 |未使用|
        | SW_Z0_10K/!100K |I|電流設定（インピーダンス切替） |利用|
        | SW_AMP_X10/!X1 |I| 電流設定（振幅切替） |利用|
        | ALM_LOW_BAT |O| LowBatteryアラーム出力 |未使用|
        | RMT_POWER |I| リモコンからの直接制御 |未使用|
        | RMT_80/RETHM |I| 80Hzモード・ReTHMモード切替入力 |利用|
        | RMT_Z0_10K/100K |I| リモコンからの直接制御 |未使用|
        | RMT_AMP_X10/X1 |I| リモコンからの直接制御 |未使用|
        | POWER_ON |I| 動作開始入力 |利用|
        | FRAME_SYNC |O| 80Hz時の1シーケンス毎同期信号出力（リモコン用） |利用|
        | RETHM_SYNC0 |O| ReTHM発振器同期信号（出力） |未使用|
        | RETHM_SYNC1 |O| ReTHM発振器同期信号（出力） |未使用|
        | RETHM_SYNC2 |O| ReTHM発振器同期信号（出力） |未使用|
        | RETHM_SYNC3 |O| ReTHM発振器同期信号（出力） |未使用|
        | RETHM_SYNC4 |O| ReTHM発振器同期信号（出力） |未使用|


