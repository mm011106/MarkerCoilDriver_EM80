# 設計ノート
このノートは当該機器の電子回路設計の履歴や設計意図を記録しています。</br>
回路動作の理解や改善・修理などにご利用ください

## 修正履歴
- 初版：2024/12/1  名前

## 設計の概要
### マーカコイルドライバ本体
マーカコイルドライバはMEGのセンサ近くで動作させるため、本体から輻射する電磁ノイズ、シールドルーム外から導入してくる電磁ノイズを厳しくコントロールする必要があります。</br>
そのため、マーカコイルドライバ本体は電源として充電池を採用し、さらに外部機器（MEGデータ収録装置）との接続を光ファイバを用いて電気的に絶縁することで必要十分な低ノイズを実現しています。

#### 設計のポイント
1. 電磁ノイズの低減<br></br>
    電源に充電池を使用しました。外部（交流電源）から生成した電源を使用しないことで、ノイズの流入を防ぎます。</br>
    その代償として、回路の動作電圧が5V程度に制限されてしまいますが、ドライブする電流が少ないこと、プッシュプル回路で等価的に2倍のドライブ電圧にすることで補っています。</br>
    外部との接続にはプラスティックファイバ用のトランシーバを利用しています。このトランシーバは通常10Mbps程度の高速データ通信を行うために設計されており、高電流（数十ｍA）で送信側をドライブするよう最適化されていますが、マーカコイルドライバの設計では伝送レートが非常に低いことと駆動電流により発生する磁気ノイズを低減するという目的で、トランシーバの仕様書上のドライブ条件よりも低い駆動電流になるよう設計しています。<br></br>

3. プッシュプル回路によるコイルのドライブ<br></br>
    電源電圧が5V以下と低い（実際には3.3Vでの動作）となっていますが、安定したコイル駆動のためにはできるだけ高いドライブ電圧を稼ぐ必要があります。低電圧電源の欠点を回避するため、コイルの両端を逆位相の電圧で駆動する「プッシュプル」構成のドライブ回路としました。これにより等価的に2倍の電圧でコイルを駆動することができます。</br>
    また、回路のGND電位をコイルに導入しない構成のため、MEGのセンサの近傍には比較的高インピーダンスの信号線（コイルドライブ電流の供給用電線）が近づくことになり、ドライブ回路のコモンモード電圧に高周波ノイズが発生したとしても、センサ側に影響を与えにくいと考えています。</br>
    （そもそも電池で駆動しているドライブ回路のコモンモード電圧は発生しないと考えられますが、ドライバの筐体が他の機器のGNDに接触してしまうなど、利用状況によって発生する可能性も無視できません）<br></br>

4. リモコンとの接続回路の分離<br></br>
    リモコンからの動作モード変更指示を受付けて処理する回路とマーカコイルドライバの同期信号をリモコンに送る回路の電源を、マーカコイルドライバのアナログ回路の電源を可能な限り分離しました。また、信号自身もフォトカプラにより絶縁されており、GNDラインの共通インピーダンスによるリモコン回路側の信号のアナログ回路への漏れ込みを最小限に抑えています。<br></br>

   
#### 回路の動作
1. リモコン回路(回路図　sheet 1/5)<br></br>
    リモコン回路は次の2つの仕事をしています。</br>
    - __動作モードの設定：__ </br>
        リモコンから50msより長いパルス幅のパルスが来た場合、動作モードを状態遷移図に従って変更します。パルス幅変調による1bit情報です。
        1（パルス幅が50msより長い）で動作モードが変更されます。また、0（パルス幅が50msより短い）でスタンバイ状態に戻ります。</br>
        リモコンからのモード変更指示の信号は光ファイバのトランシーバU6を通して、RCフィルタによるLPF(R26//C5)により高い周波数のパルスが除去されたのちレベルコンパレータに入力されています。これにより、誤動作を防いでいます。</br>
        その後、動作モードを決定する簡単なステートマシン(U9,U12)に入りますが、その前にパルス幅の判別が行われ(U11A)、"1"の場合はステートが更新され、”0”の場合はステートマシンがリセットされるようになっています。</br>
        ステートマシンの状態はPOWER_80とPOWER_RETHMの2つの信号によってドライブ回路側に渡されています。（ともにフォトカプラU7,U8を経由しています）
    <br></br>
    - __同期信号の送出：__ </br>
        マーカコイルドライバ回路の同期信号はフォトカプラ(U1)を経由してリモコン回路に導入されます。この信号はU4のバッファにより電流増幅され、光ファイバのトランスミッタ(U3)をドライブします。U4のバッファICのドライブ能力は1つのゲートあたり6mAで、それを7本並列に使用しているので理論上は40mA以上のドライブができる計算ですが、実際の電流上限はU4の絶対最大定格により規定されます。この回路ではトランスミッタのドライブ電流は8mA程度となっています。</br>
        長いファイバを使う必要があるなどの場合、R5を調整してトランスミッタからの光強度をあげることも可能です。その場合、U4の絶対最大定格を考慮して電流設定を行なってください。 </br>
        バッファICは同期信号が必要な80Hz動作モードでのみ有効になるように設計されています(U4-G1/G2)。<br></br>
    

1. コイルドライブ回路（80Hzモード） (回路図 Sheet 2/5)<br></br>
    コイルドライブ回路は次の回路で構成されています。</br>
    - __80Hz発振回路：__ </br>

    - __プッシュプル/電流設定回路：__ </br>
    - __マルチプレクサ：__ </br>
    - __中間電位設定回路：__ </br>
    - __電源電圧監視回路：__ </br> 
    - __クロック作成回路：__ </br>
