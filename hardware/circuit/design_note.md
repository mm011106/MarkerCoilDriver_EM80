# 設計ノート
このノートは当該機器の電子回路設計の履歴や設計意図を記録しています。</br>
回路動作の理解や改善・修理などにご利用ください

## 修正履歴
- 初版：2024/12/1  名前

## 設計の概要
### マーカコイルドライバ本体
マーカコイルドライバはMEGのセンサ近くで動作させるため、本体から輻射する電磁ノイズ、シールドルーム外から導入してくる電磁ノイズを厳しくコントロールする必要があります。</br>
そのため、マーカコイルドライバ本体は電源として充電池を採用し、さらに外部機器（MEGデータ収録装置）との接続を光ファイバを用いて電気的に絶縁することで必要十分な低ノイズを実現しています。

#### 設計のポイント
1. 電磁ノイズの低減<br></br>
    電源に充電池を使用しました。外部（交流電源）から生成した電源を使用しないことで、ノイズの流入を防ぎます。</br>
    その代償として、回路の動作電圧が5V程度に制限されてしまいますが、ドライブする電流が少ないこと、プッシュプル回路で等価的に2倍のドライブ電圧にすることで補っています。</br>
    外部との接続にはプラスティックファイバ用のトランシーバを利用しています。このトランシーバは通常10Mbps程度の高速データ通信を行うために設計されており、高電流（数十ｍA）で送信側をドライブするよう最適化されていますが、マーカコイルドライバの設計では伝送レートが非常に低いことと駆動電流により発生する磁気ノイズを低減するという目的で、トランシーバの仕様書上のドライブ条件よりも低い駆動電流になるよう設計しています。<br></br>

3. プッシュプル回路によるコイルのドライブ<br></br>
    電源電圧が5V以下と低い（実際には3.3Vでの動作）となっていますが、安定したコイル駆動のためにはできるだけ高いドライブ電圧を稼ぐ必要があります。低電圧電源の欠点を回避するため、コイルの両端を逆位相の電圧で駆動する「プッシュプル」構成のドライブ回路としました。これにより等価的に2倍の電圧でコイルを駆動することができます。</br>
    また、回路のGND電位をコイルに導入しない構成のため、MEGのセンサの近傍には比較的高インピーダンスの信号線（コイルドライブ電流の供給用電線）が近づくことになり、ドライブ回路のコモンモード電圧に高周波ノイズが発生したとしても、センサ側に影響を与えにくいと考えています。</br>
    （そもそも電池で駆動しているドライブ回路のコモンモード電圧は発生しないと考えられますが、ドライバの筐体が他の機器のGNDに接触してしまうなど、利用状況によって発生する可能性も無視できません）<br></br>

4. リモコンとの接続回路の分離<br></br>
    リモコンからの動作モード変更指示を受付けて処理する回路とマーカコイルドライバの同期信号をリモコンに送る回路の電源を、マーカコイルドライバのアナログ回路の電源を可能な限り分離しました。また、信号自身もフォトカプラにより絶縁されており、GNDラインの共通インピーダンスによるリモコン回路側の信号のアナログ回路への漏れ込みを最小限に抑えています。<br></br>

   
#### 回路の動作
1. リモコン回路(回路図　sheet 1/5)<br></br>
    リモコン回路は次の2つの仕事をしています。</br>
    - __動作モードの設定：__ </br>
        リモコンから50msより長いパルス幅のパルスが来た場合、動作モードを状態遷移図に従って変更します。パルス幅変調による1bit情報です。
        1（パルス幅が50msより長い）で動作モードが変更されます。また、0（パルス幅が50msより短い）でスタンバイ状態に戻ります。</br>
        リモコンからのモード変更指示の信号は光ファイバのトランシーバU6を通して、RCフィルタによるLPF(R26//C5)により高い周波数のパルスが除去されたのちレベルコンパレータに入力されています。これにより、誤動作を防いでいます。</br>
        その後、動作モードを決定する簡単なステートマシン(U9,U12)に入りますが、その前にパルス幅の判別が行われ(U11A)、判別結果に従ってステートマシンが更新されます。</br>
        ステートマシンの状態はPOWER_80とPOWER_RETHMの2つの信号によってドライブ回路側に渡されています。（ともにフォトカプラU7,U8を経由しています）
    <br></br>
    - __同期信号の送出：__ </br>
        マーカコイルドライバ回路の同期信号はフォトカプラ(U1)を経由してリモコン回路に導入されます。この信号はU4のバッファにより電流増幅され、光ファイバのトランスミッタ(U3)をドライブします。U4のバッファICのドライブ能力は1つのゲートあたり6mAで、それを7本並列に使用しているので理論上は40mA以上のドライブができる計算ですが、実際の電流上限はU4の絶対最大定格により規定されます。この回路ではトランスミッタのドライブ電流は8mA程度となっています。</br>
        長いファイバを使う必要があるなどの場合、R5を調整してトランスミッタからの光強度をあげることも可能です。その場合、U4の絶対最大定格を考慮して電流設定を行なってください。 </br>
        バッファICは80Hzモード、ReTHMモードの場合にイネーブルになります(U4-G1/G2)。<br></br>
    

1. コイルドライブ回路（80Hzモード） (回路図 Sheet 2/5)<br></br>
    コイルドライブ回路は次の回路で構成されています。</br>
    - __80Hz発振回路：__ </br>
        U15の2個のオペアンプで構成されるのが、80Hzモードでのドライブ信号を発生するための発振器です。</br>
        R51で発振周波数を調整、R40で振幅を調整します。発振周波数と振幅を設計値に収束させるためには2〜3回程度の交互調整が必要です。
        <br></br>

    - __プッシュプル/電流設定回路：__ </br>
    
    - __マルチプレクサ：__ </br>

    - __中間電位設定回路：__ </br>
        発振回路とプッシュプルドライブ回路を動作させるためには、動作の中心となる中間電位が必要となります。その電位を発生するための回路がU14Bを用いて構成されています。</br>
        アナログ回路全体の電圧が3.3Vですので、その中間の電圧、1.65VをR68,R71で生成しU14Bでバッファリングし、C28により安定化／高域での低インピーダンス化をしています。
        <br></br>

    - __電源電圧監視回路：__ </br> 
        バッテリ電圧の状態を監視するために電圧監視IC（U19）を導入しています。</br>
        バッテリの電圧が4.79Vより低くなった場合、LOW_BAT信号をアクティブにして本体パネルのLED表示とCPLDへの通知を行います。この設計では、LOW_BATのアサートにより動作が停止が停止するということはありません。 </br>
        バッテリ残量のスレッショルド4.79Vは、充電池（eneloopを想定）4本合計の定格電圧から設定しています。高負荷の場合、電池の内部抵抗により1本あたり1.2Vの電位は発生できませんが、この回路は低消費電力で電池の負荷電流は500uA程度ですので、満充電の状態の電池1本あたり1.2Vを超えて電圧を発生することを確認しています。</br>
        この電圧設定にて、満充電の電池を使用したLOW_BAT信号がアクティブになるまでの連続動作テストを行い、60時間程度の連続動作を確認しています。
        <br></br>

    - __クロック作成回路：__ </br>
        80Hzの発振回路からの正弦波をコンパレータ(U17)で矩形波に変換し、パルスシーケンスをコントロールするCPLDのためのクロック信号を作成しています。コンパレートレベルは電源電圧の中間電位近辺です。</br>
        コンパレータは若干のスレッショルドを設定しており、80Hzの信号のノイズに対するクロックの安定性を考慮しています。また、CPLDからのCOMP_80信号によりコンパレータの動作on/offが可能です。（この設計では使用していません）<br></br>
